#!/bin/bash

set -e
set -u

PIDFILE=/var/vcap/sys/run/directorweb-webapp/phpfpm.pid
LOGDIR=/var/vcap/sys/log/directorweb-webapp
CACHEDIR=/var/vcap/jobs/directorweb-webapp/cache

mkdir -p "$LOGDIR"
chown vcap:vcap "$LOGDIR"

mkdir -p "$CACHEDIR"
chown vcap:vcap "$CACHEDIR"

exec >> $LOGDIR/phpfpm-control.log
exec 2>&1

mkdir -p `dirname "$PIDFILE"`


case $1 in

  start)    
    /sbin/start-stop-daemon \
      --pidfile $PIDFILE \
      --exec /bin/bash \
      --start \
      -- -c "/var/vcap/packages/directorweb-php/sbin/php-fpm \
        -y /var/vcap/jobs/directorweb/etc/phpfpm.ini \
        >> $LOGDIR/phpfpm-stdout.log \
        2>> $LOGDIR/phpfpm-stderr.log \
      "

    ;;

  stop)
    /sbin/start-stop-daemon \
      --pidfile $PIDFILE \
      --signal QUIT \
      --oknodo \
      --stop \
      --retry 15

    ;;

  *)
    echo "Usage: control {start|stop}" >&2

    exit 1

    ;;

esac
